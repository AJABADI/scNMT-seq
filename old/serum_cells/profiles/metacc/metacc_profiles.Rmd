---
title: "NMT-seq: profiles of methylation and accessibility"
author: "Ricard Argelaguet and Stephen Clark"
output: 
  BiocStyle::html_document: 
    fig_width: 10
    fig_height: 8
---

The idea here is to take a window around predefined positions in the genome (i.e. TSS) and plot the methylation levels and DNA accessibility. We can do one of this plots for each cell, but to keep the plot uncluttered we are going to draw the average line with standard deviation that shows the variability between cells.
Also, loading all cells usually takes too much RAM memory, so we are going to use only a subset of cells with similar mean methylation rate values

```{r load_modules, echo=FALSE, include=FALSE}
library(data.table)
library(purrr)
library(ggplot2)
```

```{r fncs, echo=FALSE}
loadMultipleMetData <- function(files, context) {
  data <- files %>% map(~ fread(sprintf("zcat < %s",.x), sep="\t", verbose=F, stringsAsFactors=F, showProgress=F))
  names(data) <- opts$cells
  list(data,names(data)) %>% pwalk(~.x[,sample:=.y])
  data <- rbindlist(data)
  colnames(data) <- c("chr","pos","rate","sample")
  return(data)
}
```


```{r define_options, echo=FALSE}
io <- list()
if (grepl("ricard",Sys.info()['nodename'])) {
  io$basedir <- "/Users/ricard/data/NMT-seq"
  io$outdir <- "/Users/ricard/NMT-seq/profiles/metacc/out"
} else {
  stop()
  io$basedir <- "/hps/nobackup/stegle/users/ricard/NMT-seq"
  io$outdir <- "/homes/ricard/NOME-seq/profiles/metacc/out"
}
io$in.sample_metadata <- paste0(io$basedir,"/sample_info.txt")
io$features.indir <- paste(io$basedir,"features/filt",sep="/")
io$met.indir <- paste(io$basedir,"met/raw/filtered/unstranded/binarised/",sep="/")
io$acc.indir <- paste(io$basedir,"acc/raw/filtered/unstranded/binarised/",sep="/")

opts <- list()
opts$window_size <- 1500 # in bp
opts$tile <- 25          # window size to calculate methylation rates 

# Define which cells to use (ideally they should have similar mean methylation rate)
# opts$cells <- c("A07","A08","A09","B02","C03","C04","C09","D07","D08","E03","F05","F08","G01","G03","G06","H02","H03","H05")
opts$cells <- c("A07","A08","A09")

# Define which annotations to use and where to center the windows
opts$annotations <- c(
  # "prom_2000_2000"="center",
  "prom_2000_2000_cgi"="center",
  "prom_2000_2000_noncgi"="center",
  # "prom_2000_2000_active"="center",
  # "prom_2000_2000_inactive"="center",
  # "prom_2000_2000_poised"="center",
  "active_enhancers"="center",
  "super_enhancers"="center",
  "primed_enhancers"="center",
  "CTCF"="center",
  "p300"="center",
  "Nanog"="center",
  "Oct4"="center",
  "DHS"="center"
)

```

```{r print_opts, echo=FALSE}
cat(sprintf("- Cells: %s\n",paste(opts$cells,collapse=" ")))
cat(sprintf("- Window size: %d\n",opts$window_size))
cat(sprintf("- Tile: %d\n",opts$tile))
```

```{r load_data, echo=FALSE}
met <- loadMultipleMetData(paste0(io$met.indir,opts$cells,".tsv.gz"), context="CG") %>% .[,c("start","end","context") := list(pos,pos,"CG")] %>% setnames("pos","bp")
acc <- loadMultipleMetData(paste0(io$acc.indir,opts$cells,".tsv.gz"), context="GC") %>% .[,c("start","end","context") := list(pos,pos,"GC")] %>% setnames("pos","bp")

# Combine met and acc into one object and remove old data to free some space
data <- rbind(met,acc) %>% setkey(chr, start, end); rm(acc,met)
```

```{r load_annotations, echo=FALSE, warning=FALSE}
anno_list <- list()
for (anno in names(opts$annotations)) {
  anno_list[[anno]] <- fread(sprintf("%s/%s.bed",io$features.indir,anno))[,c(1,2,3,4,6)]
  colnames(anno_list[[anno]]) <- c("chr","start","end","strand","anno")
}
anno_df <- rbindlist(anno_list)[,anno:=as.factor(anno)][,chr:=as.factor(sub("chr","",chr))]; rm(anno_list)
setkey(anno_df,"anno")

```

<!-- We can define the central positon to be either the start, the center or the end of the annotation. -->
```{r define_windows, echo=FALSE}
tmp <- list()
for (anno in names(opts$annotations)) {
  
  if (opts$annotations[anno] == "start") {
    tmp[[anno]] <- rbind(anno_df[anno,][strand == "+",.(chr,start,strand,anno)][, center := start][,c("start") := list(NULL) ], 
                         anno_df[anno,][strand == "-",.(chr,end,strand,anno)][, center := end][,c("end") := list(NULL) ]) 
  }
  
  if (opts$annotations[anno] == "center") {
    stopifnot(all(anno_df[anno,end] > anno_df[anno,start]))
    tmp[[anno]] <- anno_df[anno,.(chr,start,end,strand,anno)][, center := round(end+start)/2][,c("start","end") := list(NULL,NULL)]
  }
  
  if (opts$annotations[anno] == "end") {
    tmp[[anno]] <- rbind(anno_df[anno,][strand == "+",.(chr,end,strand,anno)][, center := end][,c("end") := list(NULL) ], 
                         anno_df[anno,][strand == "-",.(chr,start,strand,anno)][, center := start][,c("start") := list(NULL) ]) 
  }
}

tmp <- tmp %>% rbindlist %>% .[, c("start","end") := list(center-opts$window_size,center+opts$window_size)] %>% setkey(chr, start, end)
```

```{r overlap, echo=FALSE}
ov <- foverlaps(data, tmp, nomatch = 0)[, c("start","end","i.start", "i.end") := NULL] 
# rm(data) # remove old data to free some space
ov <-  rbind(ov[strand == "+"][, dist := bp-center],
             ov[strand == "-"][, dist := center-bp],
             ov[strand == "*"][, dist := bp-center])
```

```{r preproc_data, echo=FALSE, include=FALSE, warning=FALSE}
to.plot <- ov[, dist := opts$tile*round(dist/opts$tile)][,list(mean=mean(rate)),by=.(sample,context,dist,anno)]
# rm(ov) # remove data to free some space

# Rename annotations
anno_names <- c(
  "prom_2000_2000_cgi"="CGI promoters",
  "prom_2000_2000_noncgi"="non-CGI promoters",
  "prom_2000_2000_active"="Active promoters",
  "prom_2000_2000_inactive"="Inactive promoters",
  "prom_2000_2000_poised"="Poised promoters","prom$"="Promoters",
  "active_enhancers"="Active enhancers",
  "super_enhancers"="Super enhancers",
  "primed_enhancers"="Primed enhancers"
)
to.plot$anno <- stringr::str_replace_all(to.plot$anno,anno_names)
setkey(to.plot,anno)
```

```{r acccessibility_plots, echo=FALSE, include=TRUE, warning=FALSE}
f <- function(x) { return(data.frame(y=mean(x), ymin=mean(x)-sd(x), ymax=mean(x)+sd(x))) }

annos <- c("CTCF","Nanog","DHS","Oct4","Active enhancers", "Super enhancers")
# for (n in unique(to.plot$anno)) {
p_list <- list()
for (n in annos) {
    p <- ggplot(to.plot[n,], aes(x=dist, y=mean)) +
    stat_summary(aes(group=context, colour=context, fill=context, linetype=context), fun.data=f, geom="smooth") + 
    ggtitle(n) +
    xlim(-opts$window_size, opts$window_size) +
    ylim(0,70) +
    xlab("Genomic distance from TSS") +
    ylab("Methylation/Accessibility rate") +
    scale_linetype_manual(values=c("CG"="solid", "GC"="solid")) +
    scale_colour_manual(values=c("CG"="#F8766D","GC"="#00BFC4"), labels=c("CpG methylation","GpC accessibility")) +
    guides(fill=FALSE, linetype=FALSE) +
    theme(
      plot.margin = unit(c(t=1,r=1,b=1,l=1), "cm"),
      plot.title = element_text(size=25,hjust=0.5),
      axis.text=element_text(size=16, colour="black"),
      axis.title.x=element_text(size=17, margin=margin(10,0,0,0)),
      axis.title.y=element_text(size=17, margin=margin(0,10,0,0)),
      axis.line = element_line(size=rel(1.0)),
      axis.ticks = element_line(size=rel(1.5), color="black"),
      legend.key = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      # legend.key.size= unit(0.5, "cm"),
      legend.key.width=unit(1.2,"line"),
      legend.key.height=unit(1.0,"line"),
      legend.margin = margin(t=10, r=0, b=0, l=0, unit="pt"),
      legend.title = element_blank(),
      legend.text = element_text(size=17),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      panel.background=element_blank()
    )
  print(p)
  p_list[[n]] <- p
}

pp <- cowplot::plot_grid(p_list[[1]],p_list[[2]],p_list[[3]],p_list[[4]],p_list[[5]],p_list[[6]], ncol=3, nrow=2)
print(pp)
# pdf(file=paste0(io$outdir,"/out.pdf"), width=18, height=12, useDingbats=F)
# print(pp)
# dev.off()
```


```{r acccessibility_plots, echo=FALSE, include=TRUE, warning=FALSE}

# Rename annotations
# to.plot$anno <- stringr::str_replace_all(to.plot$anno,anno_names)

annos <- c("CTCF","Nanog","DHS","Oct4","Active enhancers", "Super enhancers")
f <- function(x) { return(data.frame(y=mean(x), ymin=mean(x)-sd(x), ymax=mean(x)+sd(x))) }
for (n in annos) {
  for (i in unique(to.plot$sample)) {
    p <- ggplot(ov[anno==n & sample==i,], aes(x=dist, y=mean)) +
      stat_summary(aes(group=context, colour=context, fill=context, linetype=context), fun.data=f, geom="smooth") + 
      ggtitle(paste(n,i,sep=" ")) +
      xlim(-opts$window_size, opts$window_size) +
      ylim(0,70) +
      xlab("Genomic distance from TSS") +
      ylab("Methylation/Accessibility rate") +
      scale_linetype_manual(values=c("CG"="solid", "GC"="solid")) +
      scale_colour_manual(values=c("CG"="#F8766D","GC"="#00BFC4"), labels=c("CpG methylation","GpC accessibility")) +
      guides(fill=FALSE, linetype=FALSE) +
      theme(
        plot.margin = unit(c(t=1,r=1,b=1,l=1), "cm"),
        plot.title = element_text(size=25,hjust=0.5),
        axis.text=element_text(size=16, colour="black"),
        axis.title.x=element_text(size=17, margin=margin(10,0,0,0)),
        axis.title.y=element_text(size=17, margin=margin(0,10,0,0)),
        axis.line = element_line(size=rel(1.0)),
        axis.ticks = element_line(size=rel(1.5), color="black"),
        legend.key = element_blank(),
        legend.position = "top",
        legend.direction = "horizontal",
        # legend.key.size= unit(0.5, "cm"),
        legend.key.width=unit(1.2,"line"),
        legend.key.height=unit(1.0,"line"),
        legend.margin = margin(t=10, r=0, b=0, l=0, unit="pt"),
        legend.title = element_blank(),
        legend.text = element_text(size=17),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.background=element_blank()
      )
  print(p)
  }
}

# pp <- cowplot::plot_grid(p_list[[1]],p_list[[2]],p_list[[3]],p_list[[4]],p_list[[5]],p_list[[6]], ncol=3, nrow=2)
# print(pp)
# pdf(file=paste0(io$outdir,"/out.pdf"), width=18, height=12, useDingbats=F)
# print(pp)
# dev.off()

```


<!-- ```{r adhoc_function, echo=FALSE, include=FALSE} -->
<!-- adhoc.plot <- function(tmp) { -->
<!--   p <- ggplot(tmp, aes(x=dist, y=mean)) + -->
<!--     # stat_summary(aes(group=anno_context, linetype=context, fill=anno, color=anno), fun.data=mean_se, geom="smooth", alpha=0.2) + -->
<!--     stat_summary(aes(group=anno_context, linetype=anno, fill=context, color=context), fun.data=mean_se, geom="smooth", alpha=0.2) + -->
<!--     xlim(-opts$window_size, opts$window_size) + -->
<!--     ylim(0,70) + -->
<!--     xlab("Genomic distance") + -->
<!--     ylab("Methylation/Accessibility rate") + -->
<!--     # scale_linetype_manual(labels=c("CG methylation","GC accessibility"), values=c("dashed","solid")) + -->
<!--     # guides( -->
<!--     #   colour=guide_legend(title=""), fill=FALSE, -->
<!--     #   linetype=guide_legend(override.aes=list(color="black"), title="") -->
<!--     #   ) + -->
<!--     theme( -->
<!--       plot.margin = unit(c(t=1,r=1,b=1,l=1), "cm"), -->
<!--       plot.title = element_text(size=25,hjust=0.5), -->
<!--       axis.text=element_text(size=17, colour="black"), -->
<!--       axis.title=element_text(size=18), -->
<!--       axis.line = element_line(size=rel(1.0)), -->
<!--       axis.ticks = element_line(size=rel(1.5), color="black"), -->
<!--       legend.key = element_blank(), -->
<!--       legend.position = "top", -->
<!--       legend.direction = "vertical", -->
<!--       # legend.key.size= unit(0.5, "cm"), -->
<!--       legend.key.width=unit(1.2,"line"), -->
<!--       legend.key.height=unit(1.0,"line"), -->
<!--       legend.margin = margin(t=10, r=0, b=0, l=0, unit="pt"), -->
<!--       # legend.title = element_text(size=15), -->
<!--       legend.text = element_text(size=13), -->
<!--       panel.border=element_blank(), -->
<!--       panel.grid.major=element_blank(), -->
<!--       panel.grid.minor=element_blank(), -->
<!--       panel.background=element_blank() -->
<!--     ) -->
<!--   return(p) -->
<!-- } -->
<!-- ``` -->

<!-- ```{r enhancers, echo=FALSE, include=TRUE, warning=FALSE} -->
<!-- n <- c("Active enhancers","Super enhancers","Poised enhancers","Primed enhancers") -->
<!-- tmp <- to.plot[n,] %>%  -->
<!--   .[,anno:=stringr::str_replace_all(anno,c("Active enhancers"="Active","Super enhancers"="Super","Primed enhancers"="Primed"))] %>%  -->
<!--   .[,anno_context:=interaction(anno,context)] -->
<!-- p_enhancers <- adhoc.plot(tmp) + ggtitle("Enhancers") -->
<!-- ``` -->

<!-- ```{r transcription_factors,  echo=FALSE, include=TRUE, warning=FALSE} -->
<!-- n <- c("Nanog","Oct4","CTCF") -->
<!-- tmp <- to.plot[n,] %>% .[,anno_context:=interaction(anno,context)] -->
<!-- p <- adhoc.plot(tmp) + ggtitle("Transcription factors") -->
<!-- ``` -->

<!-- ```{r prom_activity,  echo=FALSE, include=TRUE, warning=FALSE} -->
<!-- n <- c("Active promoters","Poised promoters","Inactive promoters") -->
<!-- tmp <- to.plot[n,] %>% .[,anno:=stringr::str_replace_all(anno,c("Active promoters"="Active","Poised promoters"="Poised","Inactive promoters"="Inactive"))] %>% .[,anno_context:=interaction(anno,context)] -->

<!-- p <- adhoc.plot(tmp) -->
<!-- p + ggtitle("Promoters") -->
<!-- ``` -->

<!-- ```{r prom_cgi,  echo=FALSE, include=TRUE, warning=FALSE} -->
<!-- n <- c("non-CGI promoters","CGI promoters") -->
<!-- tmp <- to.plot[n,] %>% .[,anno:=stringr::str_replace_all(anno,c("Active promoters"="Active","Poised promoters"="Poised","Inactive promoters"="Inactive"))] %>% .[,anno_context:=interaction(anno,context)] -->
<!-- p_proms <- adhoc.plot(tmp) + ggtitle("Promoters") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- pp <- cowplot::plot_grid(p_prom,p_enhancers,ncol=1, nrow=2) -->
<!-- pdf(file=paste0(io$outdir,"/out2.pdf"), width=6, height=12) -->
<!-- print(pp) -->
<!-- dev.off() -->
<!-- ``` -->

